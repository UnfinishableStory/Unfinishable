<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Unfinishable – The Infinite Story</title>
  <meta name="description" content="Unfinishable is an infinite storytelling experience built with hand-coded HTML. Add your sentence. Shape the multiverse.">
  <meta name="keywords" content="Unfinishable, infinite storytelling, surreal web design, recursive narratives, hand-coded HTML, experimental websites, interactive fiction, narrative loops, glitch-inspired design, collaborative writing, branching stories, web-based narrative, abstract storytelling, immersive HTML project, sentence-driven fiction, multiverse web experience">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://unfinishable.vercel.app">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <style>
    /* your entire styling here including glitch overlay styles */
  </style>
</head>
<body>
  <!-- your full layout starts here -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const binId = "6881cd93f7e7a370d1ed0679";
    const apiKey = "$2a$10$2w6uVW6XQRmenExG0Bj4W.2scp1Gis0Wy285f6QjdTmH3jqvrHtiq";
    const apiUrl = `https://api.jsonbin.io/v3/b/${binId}`;
    let currentBranches = [];

    const form = document.getElementById("sentence-form");
    const textarea = document.getElementById("newSentence");
    const container = document.getElementById("storyBranches");
    const cooldownContainer = document.getElementById("cooldown-container");
    const cooldownBar = document.getElementById("cooldown-bar");

    const forbiddenEndings = /\b(the\s+end|end\s+of\s+story|this\s+is\s+the\s+end|^end$|\bend\b|story\s+is\s+over|the\s+story\s+ends|end\s+of\s+this\s+story|this\s+story\s+is\s+finished|it\s+is\s+over)\b/i;
    const basicSwears = /\b(bitch|fuck|shit|cunt|asshole|damn|dick|pussy|slut|bastard)\b/i;
    const stylizedSwears = /\b(f[u@*]+[c*k]+|s[h#*]+[i1!]+[t7]+|b[i1!]+[t7]+[c*k]+|d[a@]+m+n+|a[s$]+s+[h0o]*[l1!]*[e3]*|c[u@]+n+t+|d[i1!]+c*k+|p[u@]+s+[s$]+y+|b[a@]+s+[t]+[a@]*r+d+|s[l1!]+u+[@*]+t+)\b/i;

    async function loadBranches() {
      container.innerHTML = "<p>Loading branches...</p>";
      try {
        const res = await fetch(`${apiUrl}/latest`, {
          headers: { "X-Master-Key": apiKey }
        });
        const data = await res.json();
        currentBranches = data.record || [];

        const validBranches = currentBranches.filter(branch =>
          branch.text && branch.text.trim() !== "" && !basicSwears.test(branch.text)
        );

        container.innerHTML = "";
        if (validBranches.length === 0) {
          container.innerHTML = "<p>No branches yet... you could be the very first. 🌟</p>";
          return;
        }

        validBranches.forEach(branch => {
          const p = document.createElement("p");
          p.textContent = "— " + branch.text;
          container.appendChild(p);
        });
      } catch (err) {
        console.error("Error loading branches:", err);
        container.innerHTML = "<p>Failed to load branches.</p>";
      }
    }

    async function saveBranch(text) {
      try {
        const updatedBranches = [...currentBranches, { text }];
        await fetch(apiUrl, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-Master-Key": apiKey
          },
          body: JSON.stringify(updatedBranches)
        });
        currentBranches = updatedBranches;
        loadBranches();
      } catch (err) {
        console.error("Error saving branch:", err);
      }
    }

    form.addEventListener("submit", async function(e) {
      e.preventDefault();
      const sentence = textarea.value.trim();
      if (!sentence) {
        alert("Please enter a sentence.");
        return;
      }

      if (
        basicSwears.test(sentence) ||
        stylizedSwears.test(sentence) ||
        forbiddenEndings.test(sentence)
      ) {
        alert("Your sentence contains blocked words or an ending. Try again with something cleaner and infinite!");
        return;
      }

      await saveBranch(sentence);
      textarea.value = "";

      form.style.display = "none";
      cooldownContainer.style.display = "block";
      cooldownBar.style.width = "0%";
      setTimeout(() => {
        cooldownBar.style.width = "100%";
      }, 50);
      setTimeout(() => {
        form.style.display = "flex";
        cooldownContainer.style.display = "none";
        cooldownBar.style.width = "0%";
      }, 10000);
    });

    loadBranches();

    // 🌐 Glitch Easter Egg Logic
    const inputFields = document.querySelectorAll("input, textarea");
    const overlay = document.getElementById("glitch-overlay");
    const escapeBtn = document.getElementById("escape-btn");

    inputFields.forEach(input => {
      input.addEventListener("input", (e) => {
        if (e.target.value.toLowerCase().includes("unfinishable")) {
          triggerGlitch();
        }
      });
    });

    escapeBtn.addEventListener("click", () => {
      console.warn("ACCESS DENIED. The loop continues.");
      showTrap();
    });

    function triggerGlitch() {
      overlay.style.display = "flex";
      console.warn("You triggered the anomaly. The loop begins.");
    }

    function showTrap() {
      document.body.innerHTML = `
        <style>
          body {
            background: #000;
            color: red;
            font-family: monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
          }
          p { font-size: 1.4rem; margin-bottom: 20px; }
        </style>
        <p>There is no way out.</p>
        <p>You're part of it now.</p>
      `;
    }
  });
</script>
</body>
</html>
